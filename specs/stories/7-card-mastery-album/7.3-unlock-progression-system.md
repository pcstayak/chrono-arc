### User Story 7.3

**Number:** `7.3`
**ID:** `BA-US-unlock-progression-system`
**Role:** `player`
**Story:** `As a player, I want to unlock album elements by completing mini-games and successfully defending cards so that I have concrete goals and rewards for engaging with historical content, motivating me to keep learning.`

**Context / Background:**
- This story implements the unlock mechanics that make the album system meaningful
- Players earn unlocks through gameplay actions: completing mini-games, defending cards, exploring content
- Each unlock is tied to a specific action or achievement (e.g., "first win", "defend successfully", "view story 3 times")
- Unlocks should feel rewarding and provide immediate positive feedback
- This creates a progression loop: play game > unlock element > see progress > motivated to unlock more
- Educational value: Rewards reinforce learning activities, encouraging repeated engagement
- Game design: Unlocks should be achievable but require effort (not given away freely)

**Functional Requirements:**
1. Define unlock conditions for each album element (e.g., "unlock after first mini-game win")
2. Monitor gameplay events that trigger unlocks (mini-game completion, successful defense, etc.)
3. Check if unlock conditions are met when relevant events occur
4. Update player progress to mark elements as unlocked
5. Display a notification or celebration animation when an unlock happens
6. Persist unlock status so it remains even after page refresh or session end
7. Prevent duplicate unlocks (if element is already unlocked, don't trigger notification again)

**Non-Functional / UX Requirements:**
- Unlock notifications must be immediate (under 500ms after triggering action)
- Notification should be visually celebratory but brief (auto-dismiss after 3-5 seconds)
- Unlock animations must be smooth and not block gameplay or navigation
- Notification should clearly show what was unlocked (preview of sticker, fact snippet, etc.)
- Must work consistently on desktop and mobile devices
- Data persistence must be reliable (use database or local storage with sync)
- Unlock checks should not cause performance degradation (run efficiently in background)

**Data & State:**
- Inputs:
  - Player ID and event card ID
  - Gameplay event (e.g., "mini_game_completed", "card_defended_successfully")
  - Album element definitions with unlock conditions
  - Current unlock status for this player and card
- Outputs:
  - Updated unlock status in persistent storage
  - Unlock notification displayed to player
  - Updated album page if currently viewing
- State rules:
  - An element can only be unlocked once (idempotent operation)
  - Unlocks are permanent (cannot be re-locked)
  - Multiple elements can unlock simultaneously from a single action
  - Unlock conditions are evaluated immediately after triggering actions
  - Unlocks for one card do not affect other cards

**Validation & Edge Cases:**
- Unlock triggered while player is not viewing the album: notification appears globally (banner or toast)
- Multiple unlocks happen at once (e.g., completing game unlocks 3 elements): show all notifications in sequence or grouped
- Unlock triggered while offline: save locally and sync when connection restored
- Player completes unlock condition but element is already unlocked: silently skip notification
- Database write fails during unlock: retry and/or cache locally to prevent loss
- Unlock condition references missing element: log error and skip without crashing
- Player refreshes page immediately after unlock: unlock is still persisted and visible
- Two different actions unlock the same element: first one wins, second is skipped

**Assumptions:**
- Each album element has a defined unlock condition (stored in database or event data)
- Unlock conditions are simple rules (e.g., "first_win", "defend_success", "view_count_3")
- Game logic emits events that can be listened to (e.g., event bus or callback system)
- Player progress is stored in Supabase database with a schema like player_unlocks(player_id, element_id, unlocked_at)
- Unlock notifications use a global notification system (toast, modal, or banner component)
- For MVP, unlock conditions are predefined per element (not dynamically customizable)
- Unlock triggers are limited to: mini-game completion, card defense, and possibly story views

**Out of Scope (for this story):**
- Complex unlock conditions (e.g., "unlock after winning 5 games" or "unlock if score > 80%")
- Unlock progression across multiple cards (e.g., "unlock after mastering 3 cards")
- Manual unlock by admin or debug tools
- Unlock hints or previews before conditions are met
- Unlock trading or gifting between players
- Detailed analytics on unlock rates or player progression patterns
- A/B testing different unlock conditions
- Unlock reversals or resets (e.g., losing unlocks if card is corrupted)

**Acceptance Criteria (Gherkin-style):**
- Given I complete a mini-game for the first time on a card, when the game ends, then at least one album element is unlocked for that card
- Given an element's unlock condition is met, when the unlock is processed, then I see a notification showing what I unlocked
- Given I successfully defend a card from attack, when the defense ends, then the appropriate album element(s) are unlocked
- Given I unlock an element while viewing the album page, when the unlock happens, then the element immediately changes from locked to unlocked on the page
- Given I unlock an element while NOT viewing the album, when the unlock happens, then I see a global notification (toast or banner)
- Given I refresh the page after unlocking elements, when the page reloads, then the unlocked elements remain unlocked
- Given I trigger an unlock condition for an already-unlocked element, when the action completes, then no notification is shown (idempotent)
- Given multiple elements unlock at once, when the unlock happens, then I see all unlocked elements in the notification (grouped or sequential)
