### User Story 5.5

**Number:** `5.5`
**ID:** `BA-US-segment-hover-popup`
**Role:** `player`
**Story:** `As a player, I want to see a popup when hovering over a segment that displays counts of safe, threatened, and attacked events so that I can understand the segment's status in detail before drilling down.`

**Context / Background:**
- Color stacking (Story 5.4) gives a visual overview, but players need specific details
- Hover popup displays exact counts of events in each state within the segment
- For better UX, if there's only one event in a particular state, show the event name instead of a count
- Example: "2 safe events, The Printing Press is threatened, 1 attacked event"
- This helps players make informed decisions about which segments to explore or defend
- On mobile, popup appears on tap (since hover doesn't exist)
- Educational goal: encourage players to think strategically about which time periods to focus on

**Functional Requirements:**
1. Display a popup/tooltip when hovering over a segment (desktop) or tapping a segment briefly (mobile)
2. Popup shows counts of events in each state within the segment:
   - "X safe events" (or "X safe" for brevity)
   - "Y threatened events" (or "Y threatened")
   - "Z attacked events" (or "Z attacked")
3. Special formatting: If count is exactly 1, show the event name instead:
   - Instead of "1 threatened event", show "[Event Name] is threatened"
4. If a state has zero events, omit it from the popup (e.g., if no attacked events, don't show "0 attacked")
5. Popup appears near the segment, positioned to avoid covering other UI elements
6. Popup disappears when the cursor leaves the segment (desktop) or when tapping outside the popup (mobile)
7. Popup should be styled consistently with the game's design system
8. Popup content updates dynamically if event states change while the popup is visible

**Non-Functional / UX Requirements:**
- Popup must appear quickly (within 100-200ms of hover)
- Popup text must be readable for kids (clear font, sufficient size)
- Popup must have high contrast and be visually distinct from the background
- Popup should not obstruct the segment itself or nearby segments
- On mobile, tap-to-show popup should not interfere with tap-to-drill-down (e.g., brief tap shows popup, longer tap or second tap drills down)
- Popup should be large enough to display content without truncation
- Use simple, kid-friendly language (e.g., "safe", "in danger", "under attack" instead of technical jargon)
- Popup should position intelligently to stay within viewport bounds

**Data & State:**
- Inputs:
  - Segment being hovered/tapped
  - List of child events within the segment
  - State of each child event (safe/threatened/attacked)
  - Cursor/tap position for popup placement
- Outputs:
  - Rendered popup with formatted text
  - Popup positioned near the hovered segment
- State rules:
  - Only one popup is visible at a time
  - Popup is dismissed when hover/tap ends
  - Popup content reflects real-time event states
  - Popup does not trigger when hovering over individual event dots (only segments)

**Validation & Edge Cases:**
- Segment with one event: show event name and state (e.g., "The Printing Press is safe")
- Segment with all events in same state: show count and state (e.g., "5 safe events")
- Empty segment: show "No events in this period" or similar message
- Segment with mixed states and some count=1: combine count and name formats (e.g., "3 safe events, The Printing Press is threatened, 2 attacked events")
- Very long event names: truncate in popup if necessary (e.g., "The Invention of... is threatened")
- Popup near viewport edge: reposition to stay within bounds (flip to other side of segment if needed)
- Rapid hover over multiple segments: dismiss previous popup immediately when hovering new segment
- Mobile: tap outside popup dismisses it without triggering other actions
- Popup during drill-down: dismiss popup before arc rebuilds

**Assumptions:**
- Popup is rendered using HTML/CSS positioned absolutely or as an SVG overlay
- Popup appears above all other timeline elements (high z-index)
- Event names are available in the data model for displaying in popups
- For MVP, English-only text with simple sentence structures
- Popup text uses consistent state terminology:
  - Safe: "safe" or "is safe"
  - Threatened: "threatened" or "is threatened"
  - Attacked: "attacked" or "under attack" or "is attacked"
- Popup does not need to be interactive (no buttons or links inside popup)
- Popup styling matches game design (colors, fonts, borders, shadows)

**Out of Scope (for this story):**
- Interactive popup with buttons (e.g., "View Details", "Drill Down")
- Popup showing additional information (event dates, descriptions, images)
- Persistent popup that remains visible on click (popup is ephemeral)
- Animated popup transitions (fade-in/out, slide)
- Popup for individual event dots (covered by hover preview in Epic 2)
- Customizable popup content or format
- Multi-language support for popup text
- Accessibility features (keyboard navigation, screen reader optimization)
- Popup history or log of previously viewed segments

**Acceptance Criteria (Gherkin-style):**
- Given I hover over a segment on desktop, when the hover is detected, then a popup appears near the segment showing event state counts
- Given a segment contains 3 safe events, 2 threatened events, and 1 attacked event, when I hover over it, then the popup displays "3 safe, 2 threatened, 1 attacked"
- Given a segment contains 2 safe events and 1 threatened event, when I hover over it, then the popup displays "2 safe events, [Event Name] is threatened"
- Given a segment contains only 1 event, when I hover over it, then the popup displays "[Event Name] is safe" (or threatened/attacked based on state)
- Given a segment has no events in the attacked state, when I hover over it, then the popup does not mention attacked events (omits "0 attacked")
- Given I move my cursor from one segment to another, when the cursor enters the new segment, then the previous popup dismisses and a new popup appears for the new segment
- Given I move my cursor off a segment, when the cursor leaves the segment area, then the popup disappears
- Given I am on mobile and tap a segment briefly, when the tap registers, then the popup appears near the segment
- Given the popup is visible on mobile and I tap outside of it, when the tap registers, then the popup dismisses without triggering other actions
- Given the popup is near the edge of the viewport, when it renders, then it repositions to stay fully within the viewport bounds
- Given event states change while the popup is visible, when the states update, then the popup content updates to reflect the new counts
