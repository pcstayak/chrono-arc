### User Story 5.4

**Number:** `5.4`
**ID:** `BA-US-segment-color-stacking`
**Role:** `player`
**Story:** `As a player, I want parent segments to display stacked colors representing the states of their child events so that I can assess the health of entire time periods at a glance without drilling down.`

**Context / Background:**
- In hierarchical navigation, parent segments contain multiple child events or sub-segments
- Without drilling down, players need to know if events within a segment are safe, threatened, or attacked
- Color stacking displays a visual "health bar" for each segment
- Colors are stacked proportionally along the segment's length based on child event states
- Example: A segment with 5 events (2 safe, 2 threatened, 1 attacked) would show 40% blue, 40% orange, 20% red
- This allows players to quickly identify which time periods need attention
- Educational goal: help kids understand that historical periods can contain both stability and conflict

**Functional Requirements:**
1. Calculate the proportion of child events in each state (safe/threatened/attacked) within a parent segment
2. Render the segment as a gradient or stacked color bar showing proportional colors:
   - Blue/green for safe events
   - Orange/yellow for threatened events
   - Red for attacked events
3. Colors are ordered consistently (e.g., always safe > threatened > attacked, left to right)
4. Each color section's length is proportional to the count of events in that state
5. If all child events are in the same state, the segment displays a single solid color
6. If a segment has no child events, display in a neutral color (e.g., gray) or default safe color
7. Update segment colors dynamically when child event states change
8. Segment colors are independent of segment hover state (orange hover highlight is separate)

**Non-Functional / UX Requirements:**
- Color stacking must be visually clear and not muddy or blended
- Transitions between color sections should be distinct (not gradual gradients)
- Colors must match the event state color scheme from Story 5.3
- Color proportions must be accurate (proportional to event counts, not arbitrary)
- Rendering must be performant even with many segments
- Color stacking should work on all segment sizes (narrow and wide)
- On mobile, color stacking remains visible and distinguishable
- Hover orange highlight should overlay the stacked colors without obscuring them

**Data & State:**
- Inputs:
  - List of child events within each parent segment
  - State of each child event (safe/threatened/attacked)
  - Segment boundaries and dimensions on the arc
- Outputs:
  - Rendered segment with stacked colors representing child event states
  - Proportional color sections along segment length
- State rules:
  - Segment colors update immediately when any child event state changes
  - Color proportions recalculate based on current child event counts
  - Segments with no children display neutral or default color
  - Color stacking applies to all hierarchical levels (a segment can have sub-segments, each with their own stacking)

**Validation & Edge Cases:**
- Segment with one event: show single solid color (no stacking)
- Segment with all events in same state: show single solid color
- Empty segment (no child events): show neutral gray or default safe color
- Very narrow segment: ensure colors are still distinguishable (minimum width per color section)
- Many events in segment (e.g., 50+ events): color stacking should still render proportionally
- Child event state changes: recalculate and re-render segment colors immediately
- Segment with sub-segments: color stacking should reflect all descendant events, not just direct children
- Hover interaction: orange highlight should overlay stacked colors without hiding them
- Decimal proportions: handle rounding (e.g., 33.33% blue, 33.33% orange, 33.33% red)

**Assumptions:**
- Color stacking is rendered as part of the segment visual (e.g., SVG path with gradient or multiple paths)
- Colors are drawn in consistent order (e.g., safe always first, attacked always last)
- Proportions are based on event counts, not on time duration or other metrics
- Stacked colors are horizontal along the arc length (not vertical or radial)
- For MVP, a simple linear gradient or multi-section path is sufficient
- Performance is acceptable with up to 50-100 segments and 1000+ total events
- State data is up-to-date and accurate (no stale state issues)
- Color stacking applies only to parent segments, not to individual event dots

**Out of Scope (for this story):**
- Animated transitions of color stacking when states change (may add as enhancement)
- Detailed breakdown showing which specific events are in which state (covered by Story 5.5 popup)
- User-configurable color schemes or accessibility modes
- Displaying exact percentages or counts on the segment itself (shown in hover popup)
- Weighted color stacking based on event importance (all events weighted equally)
- Color stacking based on criteria other than state (e.g., by event type or era)
- 3D or radial color stacking effects
- Advanced rendering optimizations (e.g., canvas-based rendering for performance)

**Acceptance Criteria (Gherkin-style):**
- Given a segment contains 2 safe events, 2 threatened events, and 1 attacked event, when I view the segment, then I see colors stacked proportionally: 40% blue, 40% orange, 20% red
- Given a segment contains only safe events, when I view the segment, then the segment is rendered in solid blue/green
- Given a segment contains only attacked events, when I view the segment, then the segment is rendered in solid red
- Given a segment has no child events, when I view the segment, then the segment is rendered in neutral gray or default safe color
- Given a child event state changes from safe to threatened, when the state updates, then the segment color stacking recalculates and re-renders to reflect the new proportions
- Given I hover over a segment with color stacking, when my cursor enters the segment, then the orange hover highlight overlays the stacked colors without hiding them
- Given a very narrow segment, when I view it, then the color stacking remains distinguishable despite limited space
- Given I drill down and then return to a parent level, when the parent segment is displayed, then the color stacking reflects the current states of all child events
- Given segments at multiple hierarchical levels, when I view the timeline, then all segments display appropriate color stacking based on their respective child events
