### User Story 6.6

**Number:** `6.6`
**ID:** `BA-US-cascade-effect-failed-defense`
**Role:** `player`
**Story:** `As a player, I want neighboring events on the timeline to be marked as "in danger" with a sad purple color when I fail to defend an event so that I understand the spreading corruption mechanic and the consequences of my failure.`

**Context / Background:**
- When a player fails to defend an event (answers quiz incorrectly), the event is corrupted
- Corruption should have consequences beyond just the single event, creating a "spreading" or "cascade" effect
- Neighboring events (chronologically adjacent on the timeline) should be marked with a "danger" status
- This danger status is a new state distinct from "safe", "threatened", and "attacked"
- Events in danger are displayed in a specific visual style: sad purple color on the timeline
- This mechanic creates higher stakes for defense and teaches cause-and-effect relationships
- Educational goal: Demonstrate how historical events are interconnected and can influence each other
- Game goal: Add strategic depth and consequence to failure, motivating careful play

**Functional Requirements:**
1. When a defense mini-game ends with failure (player answered incorrectly), trigger cascade effect logic
2. Identify the "neighboring events" for the failed/corrupted event:
   - Previous event on the timeline (chronologically before)
   - Next event on the timeline (chronologically after)
3. Update the security status of these neighboring events to a new status: "danger"
4. Apply special visual styling to events with "danger" status on the timeline:
   - Use purple color (sad/somber tone, not bright)
   - Visual indicator should feel different from "attacked" (not urgent, but melancholic/concerned)
5. Events in "danger" status remain functional (can still be explored, quizzed, etc.)
6. "Danger" status persists in game state (survives page refresh)
7. If a "danger" event is later successfully defended (if it becomes attacked), it can return to "safe" status
8. If a "danger" event is attacked and the defense fails, it also becomes corrupted and triggers its own cascade
9. Cascade effect should only affect immediate neighbors (not spread indefinitely in one failure)
10. Events that are already corrupted should not be marked as "danger" (they are already worse)

**Non-Functional / UX Requirements:**
- Cascade effect should trigger immediately after defense failure is determined (within 200ms)
- Visual update on timeline should be smooth, not jarring (transition to purple color over 0.5-1 second)
- Purple color should be distinct from other status colors (not confused with attacked, safe, or corrupted)
- The "sad" tone should be kid-appropriate (melancholic but not depressing or scary)
- Visual treatment should work on both desktop and mobile displays
- Color must be accessible (sufficient contrast against background, distinguishable for color-blind users)
- If both neighbors are affected, both should update simultaneously
- The cascade effect should be noticeable but not overwhelming (does not dominate the timeline visually)

**Data & State:**
- Inputs:
  - Event ID of the failed/corrupted event
  - Timeline data structure (ordered list of events with their chronological positions)
  - Security status of neighboring events
  - Defense outcome (success or failure from story 6.4)
- Outputs:
  - Updated "danger" status for neighboring events
  - Visual styling changes on timeline (purple color)
  - Game state update reflecting new status for affected events
- State rules:
  - Cascade triggers only when defense outcome is "failure"
  - Only immediate chronological neighbors are affected (one before, one after)
  - If a neighbor is already corrupted, skip it (do not change its status)
  - If a neighbor is at the very beginning or end of the timeline, only affect the one existing neighbor
  - "Danger" status can transition to "attacked" if the game logic triggers an attack on that event
  - "Danger" status can be cleared if the event is successfully defended later
  - Events in "danger" can still be explored normally (danger is a warning, not a lockdown)

**Validation & Edge Cases:**
- Failed event is at the start of the timeline (no previous event): only affect the next event
- Failed event is at the end of the timeline (no next event): only affect the previous event
- Failed event is the only event on the timeline: no cascade effect (no neighbors)
- Both neighboring events are already corrupted: no status change (they remain corrupted)
- One neighbor is corrupted, one is safe: only the safe one changes to danger
- Neighbor is currently under attack when cascade triggers: leave it as "attacked" (more urgent state takes priority)
- Player fails multiple events in quick succession: each triggers its own cascade (could create overlapping danger zones)
- Cascade would create a chain reaction (neighbor is in danger, then fails, triggering another cascade): allowed, spreads over time
- Timeline has gaps or non-linear structure: define "neighbor" based on actual timeline data structure, not assumed linearity
- Player refreshes browser after cascade: danger status should persist from saved game state

**Assumptions:**
- Events on the timeline have a clear chronological ordering (previous and next can be determined)
- The timeline data structure supports efficient lookup of neighboring events
- A new "danger" status can be added to the existing status system (safe, threatened, attacked, corrupted, danger)
- Visual styling for "danger" status can be defined (purple color, potentially with icon or pattern)
- The cascade effect is triggered by the defense outcome logic in story 6.4
- Game state can store the "danger" status for each event persistently
- The timeline UI can handle multiple status types and apply appropriate styling reactively
- Purple color is approved for the "danger" state (fits the game's visual design)
- "Danger" status does not prevent the event from being attacked later (it is a warning, not protection)

**Out of Scope (for this story):**
- Cascade effect triggering from other game events (only from failed defense in this story)
- Healing or restoring corrupted events back to safe status
- Visual animation or transition showing the corruption "spreading" from one event to neighbors
- Audio or sound effects for cascade triggering
- Notification or message to player explaining the cascade effect
- Gameplay mechanics for preventing or reversing danger status (beyond defending the event)
- Cascade spreading beyond immediate neighbors (multi-hop or chain reactions in a single trigger)
- Different cascade rules for different types of events or eras
- Player statistics tracking how many events are in danger
- Tutorial or in-game explanation of the cascade mechanic

**Acceptance Criteria (Gherkin-style):**
- Given I fail to defend an event, when the defense ends, then the neighboring events on the timeline are marked with "danger" status
- Given I fail to defend an event, when I view the timeline, then the neighboring events are displayed in sad purple color
- Given I fail to defend an event at the start of the timeline, when cascade triggers, then only the next event is marked as "danger"
- Given I fail to defend an event at the end of the timeline, when cascade triggers, then only the previous event is marked as "danger"
- Given I fail to defend an event with two neighbors, when cascade triggers, then both the previous and next events are marked as "danger"
- Given a neighboring event is already corrupted, when cascade triggers, then its status does not change (remains corrupted)
- Given a neighboring event is currently attacked, when cascade triggers, then its status does not change (remains attacked, more urgent)
- Given an event is in "danger" status, when I view the timeline, then it is displayed in purple and distinguishable from other statuses
- Given an event is in "danger" status, when I click on it, then I can still explore the event normally (it is not locked)
- Given multiple events fail in succession, when cascades trigger, then each creates its own danger zone around its neighbors (overlaps allowed)
- Given I fail to defend an event, when I refresh the browser, then the neighboring events remain in "danger" status (persisted)
- Given an event is in "danger" status, when I successfully defend it later (if attacked), then its status can return to "safe"
- Given I am a color-blind user, when I view events in "danger" status, then I can distinguish them from other statuses through additional visual cues (not color alone)
